name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  build-binaries:
    name: Build binaries (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build (release)
        run: cargo build --locked --release -p safe-fs-tools-cli

      - name: Package (tar.gz)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          bin_name="safe-fs-tools"
          os="$(uname -s | tr '[:upper:]' '[:lower:]')"
          if [[ "$os" == "darwin" ]]; then os="macos"; fi
          arch="$(uname -m)"
          case "$arch" in
            x86_64) arch="x64" ;;
            aarch64|arm64) arch="arm64" ;;
          esac

          asset="safe-fs-tools-${os}-${arch}.tar.gz"
          stage_root="dist/stage"
          stage_dir="${stage_root}/safe-fs-tools-${os}-${arch}"
          rm -rf "${stage_root}"
          mkdir -p "${stage_dir}"
          cp "target/release/${bin_name}" "${stage_dir}/${bin_name}"
          cp "README.md" "policy.example.toml" "${stage_dir}/"
          tar -C "${stage_root}" -czf "dist/${asset}" "safe-fs-tools-${os}-${arch}"
          (
            cd dist
            shasum -a 256 "${asset}" | awk '{print $1 "  " $2}' >"${asset}.sha256"
          )

      - name: Package (zip)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $os = "windows"
          $arch = $env:RUNNER_ARCH.ToLower()
          if ($arch -eq "x64") { $arch = "x64" }
          elseif ($arch -eq "arm64") { $arch = "arm64" }
          $asset = "safe-fs-tools-$os-$arch.zip"
          $stage = Join-Path "dist" ("safe-fs-tools-" + $os + "-" + $arch)
          New-Item -ItemType Directory -Force -Path $stage | Out-Null
          Copy-Item "target\\release\\safe-fs-tools.exe" -Destination (Join-Path $stage "safe-fs-tools.exe") -Force
          Copy-Item "README.md" -Destination (Join-Path $stage "README.md") -Force
          Copy-Item "policy.example.toml" -Destination (Join-Path $stage "policy.example.toml") -Force
          Compress-Archive -Path $stage -DestinationPath ("dist\\" + $asset) -Force
          $hash = (Get-FileHash ("dist\\" + $asset) -Algorithm SHA256).Hash.ToLower()
          "$hash  $asset" | Out-File -Encoding utf8NoBOM ("dist\\" + $asset + ".sha256")

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ matrix.os }}
          path: dist/*

  publish:
    name: Publish (GitHub Release)
    needs: build-binaries
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run workspace tests
        run: cargo test --locked --workspace

      - name: Verify tag matches crate versions
        shell: bash
        run: |
          set -euo pipefail
          metadata_json="$(mktemp)"
          cargo metadata --locked --no-deps --format-version 1 >"$metadata_json"
          python3 - "$metadata_json" <<'PY'
          import json
          import os
          import sys

          metadata_path = sys.argv[1]
          tag = os.environ.get("GITHUB_REF_NAME", "")
          version = tag[1:] if tag.startswith("v") else tag
          with open(metadata_path, "r", encoding="utf-8") as f:
            m = json.load(f)
          versions = {p["name"]: p["version"] for p in m.get("packages", [])}
          expected = ("safe-fs-tools", "safe-fs-tools-cli")

          missing = [name for name in expected if name not in versions]
          if missing:
            print(f"Missing packages in cargo metadata: {missing}", file=sys.stderr)
            sys.exit(1)

          mismatched = [(name, versions[name]) for name in expected if versions[name] != version]
          if mismatched:
            for name, v in mismatched:
              print(f"Tag version ({version}) does not match {name} version ({v})", file=sys.stderr)
            sys.exit(1)
          PY
          rm -f "$metadata_json"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-assets-*
          merge-multiple: true
          path: dist

      - name: Create SHA256SUMS.txt
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          ls -la
          cat *.sha256 >SHA256SUMS.txt

      - name: Create GitHub release (attach binaries)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*
          generate_release_notes: true
