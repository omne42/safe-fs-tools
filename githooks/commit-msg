#!/usr/bin/env bash
set -euo pipefail

msg_file="${1:-}"
if [[ -z "$msg_file" || ! -f "$msg_file" ]]; then
  echo "commit-msg: missing commit message file path" >&2
  exit 1
fi

first_line="$(head -n 1 "$msg_file" | tr -d '\r')"
git_dir="$(git rev-parse --git-dir 2>/dev/null || true)"

has_git_state() {
  local state_file="${1:?}"
  [[ -n "$git_dir" && -f "$git_dir/$state_file" ]]
}

# Allow common autogenerated messages.
case "$first_line" in
  Merge\ *)
    if has_git_state "MERGE_HEAD"; then
      exit 0
    fi
    ;;
  Revert\ \"*\")
    if has_git_state "REVERT_HEAD"; then
      exit 0
    fi
    ;;
  fixup!\ * | squash!\ *)
    if [[ "${SAFE_FS_ALLOW_FIXUP_COMMITS:-}" == "1" ]]; then
      exit 0
    fi
    ;;
esac

types="feat|fix|docs|refactor|perf|test|chore|build|ci|revert"
regex="^(${types})(\\([a-z0-9._-]+\\))?(!)?: [^[:space:]].*"

if [[ ! "$first_line" =~ $regex ]]; then
  cat >&2 <<'EOF'
commit-msg: invalid commit message.

Expected Conventional Commits format:
  <type>(<scope>)!: <subject>

Allowed types:
  feat, fix, docs, refactor, perf, test, chore, build, ci, revert

Examples:
  feat(cli): add glob command
  fix(policy): reject empty roots
  docs(readme): document deny_globs
  refactor(ops)!: make patch api streaming
EOF
  echo >&2
  echo "Got: $first_line" >&2
  exit 1
fi
