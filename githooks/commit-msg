#!/usr/bin/env bash
set -euo pipefail

msg_file="${1:-}"
if [[ -z "$msg_file" || ! -f "$msg_file" ]]; then
  echo "commit-msg: missing commit message file path" >&2
  exit 1
fi

first_line="$(head -n 1 "$msg_file" | tr -d '\r')"

# Allow common autogenerated messages.
case "$first_line" in
  Merge\ *) exit 0 ;;
  Revert\ \"*\") exit 0 ;;
  fixup!\ *) exit 0 ;;
  squash!\ *) exit 0 ;;
esac

types="feat|fix|docs|refactor|perf|test|chore|build|ci|revert"
regex="^(${types})(\\([a-z0-9._-]+\\))?(!)?: .+"

if [[ ! "$first_line" =~ $regex ]]; then
  cat >&2 <<'EOF'
commit-msg: invalid commit message.

Expected Conventional Commits format:
  <type>(<scope>)!: <subject>

Allowed types:
  feat, fix, docs, refactor, perf, test, chore, build, ci, revert

Examples:
  feat(cli): add glob command
  fix(policy): reject empty roots
  docs(readme): document deny_globs
  refactor(ops)!: make patch api streaming
EOF
  echo >&2
  echo "Got: $first_line" >&2
  exit 1
fi

